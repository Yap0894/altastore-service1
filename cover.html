
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>common: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">AltaStore/api/common/error_business_response.go (0.0%)</option>
				
				<option value="file1">AltaStore/api/common/error_controller_response.go (0.0%)</option>
				
				<option value="file2">AltaStore/api/common/success_response.go (0.0%)</option>
				
				<option value="file3">AltaStore/api/middleware/jwt.go (11.8%)</option>
				
				<option value="file4">AltaStore/api/middleware/logger.go (0.0%)</option>
				
				<option value="file5">AltaStore/api/routes.go (0.0%)</option>
				
				<option value="file6">AltaStore/api/v1/admin/controller.go (0.0%)</option>
				
				<option value="file7">AltaStore/api/v1/admin/request/insert.go (0.0%)</option>
				
				<option value="file8">AltaStore/api/v1/admin/request/update_admin.go (0.0%)</option>
				
				<option value="file9">AltaStore/api/v1/admin/request/update_admin_password.go (0.0%)</option>
				
				<option value="file10">AltaStore/api/v1/admin/response/get_admin.go (0.0%)</option>
				
				<option value="file11">AltaStore/api/v1/adminauth/controller.go (0.0%)</option>
				
				<option value="file12">AltaStore/api/v1/adminauth/response/login.go (0.0%)</option>
				
				<option value="file13">AltaStore/api/v1/user/controller.go (0.0%)</option>
				
				<option value="file14">AltaStore/api/v1/user/request/insert_user.go (0.0%)</option>
				
				<option value="file15">AltaStore/api/v1/user/request/update_user.go (0.0%)</option>
				
				<option value="file16">AltaStore/api/v1/user/request/update_user_password.go (0.0%)</option>
				
				<option value="file17">AltaStore/api/v1/user/response/get_user.go (0.0%)</option>
				
				<option value="file18">AltaStore/api/v1/userauth/controller.go (0.0%)</option>
				
				<option value="file19">AltaStore/api/v1/userauth/response/login.go (0.0%)</option>
				
				<option value="file20">AltaStore/business/admin/admin.go (100.0%)</option>
				
				<option value="file21">AltaStore/business/admin/mocks/Repository.go (82.5%)</option>
				
				<option value="file22">AltaStore/business/admin/mocks/Service.go (15.8%)</option>
				
				<option value="file23">AltaStore/business/admin/service.go (84.0%)</option>
				
				<option value="file24">AltaStore/business/adminauth/mocks/Service.go (0.0%)</option>
				
				<option value="file25">AltaStore/business/adminauth/service.go (91.3%)</option>
				
				<option value="file26">AltaStore/business/logger/service.go (0.0%)</option>
				
				<option value="file27">AltaStore/business/user/mocks/Repository.go (82.5%)</option>
				
				<option value="file28">AltaStore/business/user/mocks/Service.go (15.8%)</option>
				
				<option value="file29">AltaStore/business/user/service.go (84.0%)</option>
				
				<option value="file30">AltaStore/business/user/user.go (100.0%)</option>
				
				<option value="file31">AltaStore/business/userauth/mocks/Service.go (0.0%)</option>
				
				<option value="file32">AltaStore/business/userauth/service.go (91.3%)</option>
				
				<option value="file33">AltaStore/config/config.go (79.3%)</option>
				
				<option value="file34">AltaStore/main.go (0.0%)</option>
				
				<option value="file35">AltaStore/modules/admin/repository.go (0.0%)</option>
				
				<option value="file36">AltaStore/modules/logger/repository.go (0.0%)</option>
				
				<option value="file37">AltaStore/modules/migration/migration.go (0.0%)</option>
				
				<option value="file38">AltaStore/modules/user/repository.go (0.0%)</option>
				
				<option value="file39">AltaStore/util/validator/validator.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package common

import (
        "AltaStore/business"
        "net/http"
)

const (
        errInternalServerError responseCode = "500"
        errNotFound            responseCode = "404"
        errHasBeenModified     responseCode = "400"
        errNotHavePermission   responseCode = "401"
        errPasswordMisMatch    responseCode = "403"
        errInvalidSpec         responseCode = "400"
        errDataExists          responseCode = "409"
        errUnAuthorized        responseCode = "401"
        errInvalidData         responseCode = "400"
)

// Mengembalikan respons status dari permintaan
func NewBusinessErrorResponse(err error) (int, ControllerResponse) <span class="cov0" title="0">{
        return errorMapping(err)
}</span>

func errorMapping(err error) (int, ControllerResponse) <span class="cov0" title="0">{
        switch err </span>{
        default:<span class="cov0" title="0">
                return newInternalServerErrorResponse()</span>

        case business.ErrNotFound:<span class="cov0" title="0">
                return newNotFoundResponse()</span>

        case business.ErrHasBeenModified:<span class="cov0" title="0">
                return newHasBeenModifiedResponse()</span>

        case business.ErrNotHavePermission:<span class="cov0" title="0">
                return newNotHavePermission()</span>

        case business.ErrPasswordMisMatch:<span class="cov0" title="0">
                return newErrPasswordMisMatch()</span>

        case business.ErrInvalidSpec:<span class="cov0" title="0">
                return newErrInvalidSpec()</span>

        case business.ErrDataExists:<span class="cov0" title="0">
                return newErrDataExists()</span>

        case business.ErrUnAuthorized:<span class="cov0" title="0">
                return newErrUnAuthorized()</span>
        case business.ErrInvalidData:<span class="cov0" title="0">
                return newErrInvalidData()</span>
        }
}

func newInternalServerErrorResponse() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusInternalServerError,
                ControllerResponse{errInternalServerError, "Internal Server Error", map[string]interface{}{}}
}</span>

func newNotFoundResponse() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusNotFound,
                ControllerResponse{errNotFound, "Data Not Found", map[string]interface{}{}}
}</span>

func newHasBeenModifiedResponse() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusBadRequest,
                ControllerResponse{errHasBeenModified, "Data Has Been Modified", map[string]interface{}{}}
}</span>

func newNotHavePermission() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusForbidden,
                ControllerResponse{errNotHavePermission, "Not Have Permission", map[string]interface{}{}}
}</span>

func newErrPasswordMisMatch() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusForbidden,
                ControllerResponse{errPasswordMisMatch, "Wrong Password", map[string]interface{}{}}
}</span>

func newErrInvalidSpec() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusBadRequest,
                ControllerResponse{errInvalidSpec, "Bad Request", map[string]interface{}{}}
}</span>

func newErrDataExists() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusConflict,
                ControllerResponse{errDataExists, "Data Exists", map[string]interface{}{}}
}</span>

func newErrUnAuthorized() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusUnauthorized,
                ControllerResponse{errUnAuthorized, "Unauthorized", map[string]interface{}{}}
}</span>

func newErrInvalidData() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusBadRequest,
                ControllerResponse{errInvalidData, "Invalid Data", map[string]interface{}{}}
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package common

import "net/http"

const (
        BadRequestCode responseCode = "400"
        ForbiddenCode  responseCode = "403"
        NotFoundCode   responseCode = "404"
        UnAuthorized   responseCode = "401"
)

func BadRequestResponse() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusBadRequest, ControllerResponse{BadRequestCode, "Bad Request", map[string]interface{}{}}
}</span>

func ForbiddenResponse() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusForbidden, ControllerResponse{ForbiddenCode, "Forbidden", map[string]interface{}{}}
}</span>

func NotFoundResponse() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusNotFound, ControllerResponse{NotFoundCode, "Not Found", map[string]interface{}{}}
}</span>

func UnAuthorizedResponse() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusNotFound, ControllerResponse{NotFoundCode, "UnAuthorized", map[string]interface{}{}}
}</span>
</pre>
		
		<pre class="file" id="file2" style="display: none">package common

import (
        "net/http"
)

const (
        Success responseCode = "200"
)

func SuccessResponseWithData(data interface{}) (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusOK, ControllerResponse{Success, "success", data}
}</span>

func SuccessResponseWithoutData() (int, ControllerResponse) <span class="cov0" title="0">{
        return http.StatusOK, ControllerResponse{Success, "success", map[string]interface{}{}}
}</span>
</pre>
		
		<pre class="file" id="file3" style="display: none">package middleware

import (
        "AltaStore/config"
        "errors"
        "net/http"

        "github.com/golang-jwt/jwt"
        echo "github.com/labstack/echo/v4"
        "github.com/labstack/echo/v4/middleware"
)

func init() <span class="cov8" title="1">{
        middleware.ErrJWTMissing = echo.NewHTTPError(
                http.StatusBadRequest, map[string]interface{}{
                        "code":    400,
                        "message": "missing or malformed jwt",
                })
        middleware.ErrJWTInvalid = echo.NewHTTPError(
                http.StatusUnauthorized, map[string]interface{}{
                        "code":    401,
                        "massage": "invalid or expired jwt",
                })
}</span>

func JWTMiddleware() echo.MiddlewareFunc <span class="cov0" title="0">{
        return middleware.JWTWithConfig(middleware.JWTConfig{
                SigningMethod: "HS256",
                SigningKey:    []byte(config.GetConfig().JwtSecretKey),
        })
}</span>

func ExtractTokenUser(ctx echo.Context) (string, error) <span class="cov0" title="0">{
        user := ctx.Get("user").(*jwt.Token)
        if user.Valid </span><span class="cov0" title="0">{
                claim := user.Claims.(jwt.MapClaims)
                userId := claim["userId"].(string)
                if userId == "" </span><span class="cov0" title="0">{
                        return "", errors.New("Unauthorize")
                }</span>
                <span class="cov0" title="0">return userId, nil</span>
        }
        <span class="cov0" title="0">return "", errors.New("Unauthorize")</span>
}

func ExtractTokenRule(ctx echo.Context) (bool, error) <span class="cov0" title="0">{
        user := ctx.Get("user").(*jwt.Token)
        if user.Valid </span><span class="cov0" title="0">{
                claim := user.Claims.(jwt.MapClaims)
                isAdmin := claim["isAdmin"].(bool)
                return isAdmin, nil
        }</span>
        <span class="cov0" title="0">return false, errors.New("Unauthorize")</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package middleware

// Logger middleware logs the information about each HTTP request.

import (
        "fmt"
        "net/http"
        "time"

        echo "github.com/labstack/echo/v4"
        log "github.com/sirupsen/logrus"
)

// Penformatan pencatatan sistem
func MakeLogEntry(c echo.Context) *log.Entry <span class="cov0" title="0">{
        start := time.Now()

        if c == nil </span><span class="cov0" title="0">{
                return log.WithFields(log.Fields{
                        "latency_ns": time.Since(start).Nanoseconds(),
                        "group":      "system",
                })
        }</span>

        <span class="cov0" title="0">return log.WithFields(log.Fields{
                "group":      "request",
                "method":     c.Request().Method,
                "uri":        c.Request().RequestURI,
                "remoteaddr": c.Request().RemoteAddr,
                "latency_ns": time.Since(start).Nanoseconds(),
        })</span>
}

func MiddlewareLogger(next echo.HandlerFunc) echo.HandlerFunc <span class="cov0" title="0">{
        return func(c echo.Context) error </span><span class="cov0" title="0">{
                MakeLogEntry(c).Info("Incoming Connection")
                return next(c)
        }</span>
}

func ErrorHandler(err error, c echo.Context) <span class="cov0" title="0">{
        report, ok := err.(*echo.HTTPError)
        if ok </span><span class="cov0" title="0">{
                report.Message = fmt.Sprintf("http error %d - %v", report.Code, report.Message)
        }</span> else<span class="cov0" title="0"> {
                report = echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">MakeLogEntry(c).Error(report.Message)
        c.HTML(report.Code, report.Message.(string))</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package api

import (
        "AltaStore/api/middleware"
        "AltaStore/api/v1/admin"
        "AltaStore/api/v1/adminauth"
        "AltaStore/api/v1/user"
        "AltaStore/api/v1/userauth"
        "net/http"

        echo "github.com/labstack/echo/v4"
)

func RegisterPath(e *echo.Echo,
        userController *user.Controller,
        adminController *admin.Controller,
        userAuthController *userauth.Controller,
        adminAuthController *adminauth.Controller,
) <span class="cov0" title="0">{
        if userController == nil ||
                userAuthController == nil ||
                adminController == nil ||
                adminAuthController == nil </span><span class="cov0" title="0">{
                panic("Invalid parameter")</span>
        }

        // Add logger
        <span class="cov0" title="0">e.Use(middleware.MiddlewareLogger)

        // Custome response
        e.HTTPErrorHandler = func(e error, c echo.Context) </span><span class="cov0" title="0">{
                type Response struct {
                        Code    int    `json:"code"`
                        Message string `json:"message"`
                }
                var response Response
                response.Code = http.StatusInternalServerError // defaul 500
                response.Message = "Internal Server Error"

                if he, ok := e.(*echo.HTTPError); ok </span><span class="cov0" title="0">{
                        response.Code = he.Code
                        response.Message = http.StatusText(he.Code)
                }</span>

                <span class="cov0" title="0">c.Logger().Error(e)

                _ = c.JSON(response.Code, response)</span>
        }

        // Routing
        <span class="cov0" title="0">regis := e.Group("v1/register")
        regis.POST("", userController.InsertUser)
        regis.POST("/admin", adminController.InsertAdmin)

        login := e.Group("v1/login")
        login.POST("", userAuthController.UserLogin)
        login.POST("/admin", adminAuthController.AdminLogin)

        admin := e.Group("v1/admins")
        admin.Use(middleware.JWTMiddleware())
        admin.PUT("/:id", adminController.UpdateAdmin)
        admin.DELETE("/:id", adminController.DeleteAdmin)
        admin.GET("/:id", adminController.FindAdminByID)
        admin.PUT("/:id/password", adminController.UpdateAdminPassword)

        user := e.Group("v1/users")
        user.Use(middleware.JWTMiddleware())
        user.PUT("/:id", userController.UpdateUser)
        user.DELETE("/:id", userController.DeleteUser)
        user.GET("/:id", userController.FindUserByID)
        user.PUT("/:id/password", userController.UpdateUserPassword)</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package admin

import (
        "AltaStore/api/common"
        "AltaStore/api/middleware"
        "AltaStore/api/v1/admin/request"
        "AltaStore/api/v1/admin/response"
        "AltaStore/business/admin"

        uuid "github.com/google/uuid"
        echo "github.com/labstack/echo/v4"
)

//Controller Get item API controller
type Controller struct {
        service admin.Service
}

//NewController Construct item API controller
func NewController(service admin.Service) *Controller <span class="cov0" title="0">{
        return &amp;Controller{
                service,
        }
}</span>

// InsertAdmin Create new Admin handler
func (controller *Controller) InsertAdmin(c echo.Context) error <span class="cov0" title="0">{
        insertAdminRequest := new(request.InsertAdminRequest)

        if err := c.Bind(insertAdminRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>

        <span class="cov0" title="0">admin := *insertAdminRequest.ToUpsertAdminSpec()

        err := controller.service.InsertAdmin(admin)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}

//GetItemByID Get item by ID echo handler
func (controller *Controller) FindAdminByID(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        _, err := middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>

        <span class="cov0" title="0">admin, err := controller.service.FindAdminByID(id.String())
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">response := response.NewGetAdminResponse(*admin)

        return c.JSON(common.SuccessResponseWithData(response))</span>
}

// UpdateAdmin update existing Admin handler
func (controller *Controller) UpdateAdmin(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        adminId, err := middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>
        <span class="cov0" title="0">if adminId != id.String() </span><span class="cov0" title="0">{
                return c.JSON(common.ForbiddenResponse())
        }</span>
        <span class="cov0" title="0">updateAdminRequest := new(request.UpdateAdminRequest)

        if err = c.Bind(updateAdminRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>
        <span class="cov0" title="0">admin := *updateAdminRequest.ToUpsertAdminSpec()

        err = controller.service.UpdateAdmin(id.String(), admin, adminId)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}

// UpdateAdminPassword update existing Admin handler
func (controller *Controller) UpdateAdminPassword(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        updateAdminPasswordRequest := new(request.UpdateAdminPasswordRequest)

        adminId, err := middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>
        <span class="cov0" title="0">if adminId != id.String() </span><span class="cov0" title="0">{
                return c.JSON(common.ForbiddenResponse())
        }</span>
        <span class="cov0" title="0">if err = c.Bind(updateAdminPasswordRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>
        <span class="cov0" title="0">admin := *updateAdminPasswordRequest.ToUpsertAdminSpec()

        err = controller.service.UpdateAdminPassword(id.String(), admin.NewPassword, admin.OldPassword, adminId)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}

// DeleteAdmin delete existing Admin handler
func (controller *Controller) DeleteAdmin(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        adminId, err := middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>
        <span class="cov0" title="0">if adminId != id.String() </span><span class="cov0" title="0">{
                return c.JSON(common.ForbiddenResponse())
        }</span>
        <span class="cov0" title="0">err = controller.service.DeleteAdmin(id.String(), adminId)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package request

import (
        "AltaStore/business/admin"
)

//InsertAdminRequest create Admin request payload
type InsertAdminRequest struct {
        Email     string `json:"email"`
        FirstName string `json:"firstname"`
        LastName  string `json:"lastname"`
        Password  string `json:"password"`
}

//ToUpsertAdminSpec convert into Admin.UpsertAdminSpec object
func (req *InsertAdminRequest) ToUpsertAdminSpec() *admin.InsertAdminSpec <span class="cov0" title="0">{
        var insertAdminSpec admin.InsertAdminSpec

        insertAdminSpec.Email = req.Email
        insertAdminSpec.FirstName = req.FirstName
        insertAdminSpec.LastName = req.LastName
        insertAdminSpec.Password = req.Password

        return &amp;insertAdminSpec
}</span>
</pre>
		
		<pre class="file" id="file8" style="display: none">package request

import (
        "AltaStore/business/admin"
)

//UpdateAdminRequest create Admin request payload
type UpdateAdminRequest struct {
        FirstName string `json:"firstname"`
        LastName  string `json:"lastname"`
}

//ToUpsertAdminSpec convert into Admin.UpsertAdminSpec object
func (req *UpdateAdminRequest) ToUpsertAdminSpec() *admin.UpdateAdminSpec <span class="cov0" title="0">{

        var updateAdminSpec admin.UpdateAdminSpec

        updateAdminSpec.FirstName = req.FirstName
        updateAdminSpec.LastName = req.LastName

        return &amp;updateAdminSpec
}</span>
</pre>
		
		<pre class="file" id="file9" style="display: none">package request

import (
        "AltaStore/business/admin"
)

//UpdateAdminRequest create Admin request payload
type UpdateAdminPasswordRequest struct {
        NewPassword string `json:"newpassword"`
        OldPassword string `json:"oldpassword"`
}

//ToUpsertAdminSpec convert into Admin.UpsertAdminSpec object
func (req *UpdateAdminPasswordRequest) ToUpsertAdminSpec() *admin.UpdateAdminPasswordSpec <span class="cov0" title="0">{

        var updateAdminPasswordSpec admin.UpdateAdminPasswordSpec

        updateAdminPasswordSpec.NewPassword = req.NewPassword
        updateAdminPasswordSpec.OldPassword = req.OldPassword

        return &amp;updateAdminPasswordSpec
}</span>
</pre>
		
		<pre class="file" id="file10" style="display: none">package response

import (
        "AltaStore/business/admin"
)

//GetAdminResponse Get Admin by ID response payload
type GetAdminResponse struct {
        ID        string `json:"id"`
        Email     string `json:"email"`
        FirstName string `json:"name"`
        LastName  string `json:"Adminname"`
}

//NewGetAdminResponse construct GetAdminResponse
func NewGetAdminResponse(Admin admin.Admin) *GetAdminResponse <span class="cov0" title="0">{
        var getAdminResponse GetAdminResponse

        getAdminResponse.ID = Admin.ID
        getAdminResponse.Email = Admin.Email
        getAdminResponse.FirstName = Admin.FirstName
        getAdminResponse.LastName = Admin.LastName

        return &amp;getAdminResponse
}</span>
</pre>
		
		<pre class="file" id="file11" style="display: none">package adminauth

import (
        "AltaStore/api/common"
        "AltaStore/api/v1/adminauth/request"
        "AltaStore/api/v1/adminauth/response"
        auth "AltaStore/business/adminauth"
        "net/http"
        "time"

        echo "github.com/labstack/echo/v4"
)

//Controller Get item API controller
type Controller struct {
        service auth.Service
}

//NewController Construct item API controller
func NewController(service auth.Service) *Controller <span class="cov0" title="0">{
        return &amp;Controller{
                service,
        }
}</span>

//Login by given adminname and password will return JWT token
func (controller *Controller) AdminLogin(c echo.Context) error <span class="cov0" title="0">{
        loginRequest := new(request.LoginRequest)

        if err := c.Bind(loginRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>

        <span class="cov0" title="0">token, err := controller.service.AdminLogin(loginRequest.Email, loginRequest.Password)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">response := response.NewLoginResponse(token)

        cookie := &amp;http.Cookie{}
        cookie.Name = "JWT"
        cookie.Value = token
        cookie.Expires = time.Now().Add(time.Hour * 24)
        cookie.HttpOnly = true

        c.SetCookie(cookie)

        return c.JSON(common.SuccessResponseWithData(response))</span>
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package response

//Login response payload
type LoginResponse struct {
        Token string `json:"token"`
}

//NewLoginResponse construct LoginResponse
func NewLoginResponse(token string) *LoginResponse <span class="cov0" title="0">{
        var LoginResponse LoginResponse

        LoginResponse.Token = token

        return &amp;LoginResponse
}</span>
</pre>
		
		<pre class="file" id="file13" style="display: none">package user

import (
        "AltaStore/api/common"
        "AltaStore/api/middleware"
        "AltaStore/api/v1/user/request"
        "AltaStore/api/v1/user/response"
        "AltaStore/business/user"

        uuid "github.com/google/uuid"
        echo "github.com/labstack/echo/v4"
)

//Controller Get item API controller
type Controller struct {
        service user.Service
}

//NewController Construct item API controller
func NewController(service user.Service) *Controller <span class="cov0" title="0">{
        return &amp;Controller{
                service,
        }
}</span>

// InsertUser Create new user handler
func (controller *Controller) InsertUser(c echo.Context) error <span class="cov0" title="0">{
        insertUserRequest := new(request.InsertUserRequest)

        if err := c.Bind(insertUserRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>

        <span class="cov0" title="0">user := *insertUserRequest.ToUpsertUserSpec()

        err := controller.service.InsertUser(user)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}

//GetItemByID Get item by ID echo handler
func (controller *Controller) FindUserByID(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        user, err := controller.service.FindUserByID(id.String())
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>
        <span class="cov0" title="0">_, err = middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>
        <span class="cov0" title="0">response := response.NewGetUserResponse(*user)

        return c.JSON(common.SuccessResponseWithData(response))</span>
}

// UpdateUser update existing user handler
func (controller *Controller) UpdateUser(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        userId, err := middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>

        <span class="cov0" title="0">if userId != id.String() </span><span class="cov0" title="0">{
                return c.JSON(common.ForbiddenResponse())
        }</span>

        <span class="cov0" title="0">updateUserRequest := new(request.UpdateUserRequest)

        if err := c.Bind(updateUserRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>
        <span class="cov0" title="0">user := *updateUserRequest.ToUpsertUserSpec()

        err = controller.service.UpdateUser(id.String(), user, userId)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}

// UpdateUserPassword update existing user handler
func (controller *Controller) UpdateUserPassword(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        userId, err := middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>

        <span class="cov0" title="0">if userId != id.String() </span><span class="cov0" title="0">{
                return c.JSON(common.ForbiddenResponse())
        }</span>

        <span class="cov0" title="0">updateUserPasswordRequest := new(request.UpdateUserPasswordRequest)

        if err := c.Bind(updateUserPasswordRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>
        <span class="cov0" title="0">user := *updateUserPasswordRequest.ToUpsertUserSpec()

        err = controller.service.UpdateUserPassword(id.String(), user.NewPassword, user.OldPassword, userId)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}

// DeleteUser delete existing user handler
func (controller *Controller) DeleteUser(c echo.Context) error <span class="cov0" title="0">{
        id, _ := uuid.Parse(c.Param("id"))

        userId, err := middleware.ExtractTokenUser(c)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.UnAuthorizedResponse())
        }</span>

        <span class="cov0" title="0">if userId != id.String() </span><span class="cov0" title="0">{
                return c.JSON(common.ForbiddenResponse())
        }</span>

        <span class="cov0" title="0">err = controller.service.DeleteUser(id.String(), userId)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">return c.JSON(common.SuccessResponseWithoutData())</span>
}
</pre>
		
		<pre class="file" id="file14" style="display: none">package request

import (
        "AltaStore/business/user"
)

//InsertUserRequest create User request payload
type InsertUserRequest struct {
        Email     string `json:"email"`
        FirstName string `json:"firstname"`
        LastName  string `json:"lastname"`
        Password  string `json:"password"`
}

//ToUpsertUserSpec convert into User.UpsertUserSpec object
func (req *InsertUserRequest) ToUpsertUserSpec() *user.InsertUserSpec <span class="cov0" title="0">{
        var insertUserSpec user.InsertUserSpec

        insertUserSpec.Email = req.Email
        insertUserSpec.FirstName = req.FirstName
        insertUserSpec.LastName = req.LastName
        insertUserSpec.Password = req.Password

        return &amp;insertUserSpec
}</span>
</pre>
		
		<pre class="file" id="file15" style="display: none">package request

import (
        "AltaStore/business/user"
)

//UpdateUserRequest create User request payload
type UpdateUserRequest struct {
        FirstName string `json:"firstname"`
        LastName  string `json:"lastname"`
        HandPhone string `json:"handphone"`
        Address   string `json:"address"`
}

//ToUpsertUserSpec convert into User.UpsertUserSpec object
func (req *UpdateUserRequest) ToUpsertUserSpec() *user.UpdateUserSpec <span class="cov0" title="0">{

        var updateUserSpec user.UpdateUserSpec

        updateUserSpec.FirstName = req.FirstName
        updateUserSpec.LastName = req.LastName
        updateUserSpec.HandPhone = req.HandPhone
        updateUserSpec.Address = req.Address

        return &amp;updateUserSpec
}</span>
</pre>
		
		<pre class="file" id="file16" style="display: none">package request

import (
        "AltaStore/business/user"
)

//UpdateUserRequest create User request payload
type UpdateUserPasswordRequest struct {
        NewPassword string `json:"newpassword"`
        OldPassword string `json:"oldpassword"`
}

//ToUpsertUserSpec convert into User.UpsertUserSpec object
func (req *UpdateUserPasswordRequest) ToUpsertUserSpec() *user.UpdateUserPasswordSpec <span class="cov0" title="0">{

        var updateUserPasswordSpec user.UpdateUserPasswordSpec

        updateUserPasswordSpec.NewPassword = req.NewPassword
        updateUserPasswordSpec.OldPassword = req.OldPassword

        return &amp;updateUserPasswordSpec
}</span>
</pre>
		
		<pre class="file" id="file17" style="display: none">package response

import (
        "AltaStore/business/user"
)

//GetUserResponse Get user by ID response payload
type GetUserResponse struct {
        ID        string `json:"id"`
        Email     string `json:"email"`
        FirstName string `json:"name"`
        LastName  string `json:"username"`
        HandPhone string `json:"handphone"`
        Address   string `json:"address"`
}

//NewGetUserResponse construct GetUserResponse
func NewGetUserResponse(user user.User) *GetUserResponse <span class="cov0" title="0">{
        var getUserResponse GetUserResponse

        getUserResponse.ID = user.ID
        getUserResponse.Email = user.Email
        getUserResponse.FirstName = user.FirstName
        getUserResponse.LastName = user.LastName
        getUserResponse.HandPhone = user.HandPhone
        getUserResponse.Address = user.Address

        return &amp;getUserResponse
}</span>
</pre>
		
		<pre class="file" id="file18" style="display: none">package userauth

import (
        "AltaStore/api/common"
        "AltaStore/api/v1/userauth/request"
        "AltaStore/api/v1/userauth/response"
        auth "AltaStore/business/userauth"
        "net/http"
        "time"

        echo "github.com/labstack/echo/v4"
)

//Controller Get item API controller
type Controller struct {
        service auth.Service
}

//NewController Construct item API controller
func NewController(service auth.Service) *Controller <span class="cov0" title="0">{
        return &amp;Controller{
                service,
        }
}</span>

//Login by given username and password will return JWT token
func (controller *Controller) UserLogin(c echo.Context) error <span class="cov0" title="0">{
        loginRequest := new(request.LoginRequest)

        if err := c.Bind(loginRequest); err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.BadRequestResponse())
        }</span>

        <span class="cov0" title="0">token, err := controller.service.UserLogin(loginRequest.Email, loginRequest.Password)
        if err != nil </span><span class="cov0" title="0">{
                return c.JSON(common.NewBusinessErrorResponse(err))
        }</span>

        <span class="cov0" title="0">response := response.NewLoginResponse(token)

        cookie := &amp;http.Cookie{}
        cookie.Name = "JWT"
        cookie.Value = token
        cookie.Expires = time.Now().Add(time.Hour * 24)
        cookie.HttpOnly = true

        c.SetCookie(cookie)

        return c.JSON(common.SuccessResponseWithData(response))</span>
}
</pre>
		
		<pre class="file" id="file19" style="display: none">package response

//Login response payload
type LoginResponse struct {
        Token string `json:"token"`
}

//NewLoginResponse construct LoginResponse
func NewLoginResponse(token string) *LoginResponse <span class="cov0" title="0">{
        var LoginResponse LoginResponse

        LoginResponse.Token = token

        return &amp;LoginResponse
}</span>
</pre>
		
		<pre class="file" id="file20" style="display: none">package admin

import (
        "time"
)

//Admin
type Admin struct {
        ID        string
        Email     string
        FirstName string
        LastName  string
        Password  string
        CreatedAt time.Time
        CreatedBy string
        UpdatedAt time.Time
        UpdatedBy string
        DeletedAt time.Time
        DeletedBy string
}

//NewAdmin create new Admin
func NewAdmin(
        id string,
        email string,
        firstname string,
        lastname string,
        password string,
        creator string,
        createdAt time.Time) Admin <span class="cov8" title="1">{

        return Admin{
                ID:        id,
                Email:     email,
                FirstName: firstname,
                LastName:  lastname,
                Password:  password,
                CreatedAt: createdAt,
                CreatedBy: creator,
        }
}</span>

//ModifyAdmin update existing AdminData
func (oldData *Admin) ModifyAdmin(
        newFirstName,
        newLastName string,
        updatedAt time.Time,
        updater string) Admin <span class="cov8" title="1">{

        return Admin{
                ID:        oldData.ID,
                Email:     oldData.Email,
                FirstName: newFirstName,
                LastName:  newLastName,
                Password:  oldData.Password,
                CreatedAt: oldData.CreatedAt,
                CreatedBy: oldData.CreatedBy,
                UpdatedAt: updatedAt,
                UpdatedBy: updater,
        }
}</span>

// //ModifyAdminToken update existing AdminData
// func (oldData *Admin) ModifyAdminToken(
//         newToken string,
//         updatedAt time.Time) Admin {

//         return Admin{
//                 ID:        oldData.ID,
//                 Email:     oldData.Email,
//                 FirstName: oldData.FirstName,
//                 LastName:  oldData.LastName,
//                 Password:  oldData.Password,
//                 Token:     newToken,
//                 CreatedAt: oldData.CreatedAt,
//                 CreatedBy: oldData.CreatedBy,
//                 UpdatedAt: updatedAt,
//                 UpdatedBy: oldData.ID,
//         }
// }

//ModifyAdminPassword update existing AdminData
func (oldData *Admin) ModifyAdminPassword(
        newPassword string,
        modifier string,
        updatedAt time.Time) Admin <span class="cov8" title="1">{

        return Admin{
                ID:        oldData.ID,
                Email:     oldData.Email,
                FirstName: oldData.FirstName,
                LastName:  oldData.LastName,
                Password:  newPassword,
                CreatedAt: oldData.CreatedAt,
                CreatedBy: oldData.CreatedBy,
                UpdatedAt: updatedAt,
                UpdatedBy: modifier,
        }
}</span>

func (oldData *Admin) DeleteAdmin(
        deleteAt time.Time,
        deleter string) Admin <span class="cov8" title="1">{

        return Admin{
                ID:        oldData.ID,
                Email:     oldData.Email,
                FirstName: oldData.FirstName,
                LastName:  oldData.LastName,
                Password:  oldData.Password,
                CreatedAt: oldData.CreatedAt,
                CreatedBy: oldData.CreatedBy,
                UpdatedAt: oldData.UpdatedAt,
                UpdatedBy: oldData.UpdatedBy,
                DeletedAt: deleteAt,
                DeletedBy: deleter,
        }
}</span>
</pre>
		
		<pre class="file" id="file21" style="display: none">// Code generated by mockery v2.9.4. DO NOT EDIT.

package mocks

import (
        admin "AltaStore/business/admin"

        mock "github.com/stretchr/testify/mock"
)

// Repository is an autogenerated mock type for the Repository type
type Repository struct {
        mock.Mock
}

// DeleteAdmin provides a mock function with given fields: Admin
func (_m *Repository) DeleteAdmin(Admin admin.Admin) error <span class="cov8" title="1">{
        ret := _m.Called(Admin)

        var r0 error
        if rf, ok := ret.Get(0).(func(admin.Admin) error); ok </span><span class="cov0" title="0">{
                r0 = rf(Admin)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}

// FindAdminByEmail provides a mock function with given fields: email
func (_m *Repository) FindAdminByEmail(email string) (*admin.Admin, error) <span class="cov8" title="1">{
        ret := _m.Called(email)

        var r0 *admin.Admin
        if rf, ok := ret.Get(0).(func(string) *admin.Admin); ok </span><span class="cov0" title="0">{
                r0 = rf(email)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*admin.Admin)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// FindAdminByEmailAndPassword provides a mock function with given fields: email, password
func (_m *Repository) FindAdminByEmailAndPassword(email string, password string) (*admin.Admin, error) <span class="cov8" title="1">{
        ret := _m.Called(email, password)

        var r0 *admin.Admin
        if rf, ok := ret.Get(0).(func(string, string) *admin.Admin); ok </span><span class="cov0" title="0">{
                r0 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*admin.Admin)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// FindAdminByID provides a mock function with given fields: id
func (_m *Repository) FindAdminByID(id string) (*admin.Admin, error) <span class="cov8" title="1">{
        ret := _m.Called(id)

        var r0 *admin.Admin
        if rf, ok := ret.Get(0).(func(string) *admin.Admin); ok </span><span class="cov0" title="0">{
                r0 = rf(id)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*admin.Admin)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(id)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// InsertAdmin provides a mock function with given fields: Admin
func (_m *Repository) InsertAdmin(Admin admin.Admin) error <span class="cov8" title="1">{
        ret := _m.Called(Admin)

        var r0 error
        if rf, ok := ret.Get(0).(func(admin.Admin) error); ok </span><span class="cov0" title="0">{
                r0 = rf(Admin)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}

// UpdateAdmin provides a mock function with given fields: Admin
func (_m *Repository) UpdateAdmin(Admin admin.Admin) error <span class="cov8" title="1">{
        ret := _m.Called(Admin)

        var r0 error
        if rf, ok := ret.Get(0).(func(admin.Admin) error); ok </span><span class="cov0" title="0">{
                r0 = rf(Admin)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}

// UpdateAdminPassword provides a mock function with given fields: Admin
func (_m *Repository) UpdateAdminPassword(Admin admin.Admin) error <span class="cov8" title="1">{
        ret := _m.Called(Admin)

        var r0 error
        if rf, ok := ret.Get(0).(func(admin.Admin) error); ok </span><span class="cov0" title="0">{
                r0 = rf(Admin)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}
</pre>
		
		<pre class="file" id="file22" style="display: none">// Code generated by mockery v2.9.4. DO NOT EDIT.

package mocks

import (
        admin "AltaStore/business/admin"

        mock "github.com/stretchr/testify/mock"
)

// Service is an autogenerated mock type for the Service type
type Service struct {
        mock.Mock
}

// DeleteAdmin provides a mock function with given fields: id, modifier
func (_m *Service) DeleteAdmin(id string, modifier string) error <span class="cov0" title="0">{
        ret := _m.Called(id, modifier)

        var r0 error
        if rf, ok := ret.Get(0).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r0 = rf(id, modifier)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}

// FindAdminByEmail provides a mock function with given fields: email
func (_m *Service) FindAdminByEmail(email string) (*admin.Admin, error) <span class="cov0" title="0">{
        ret := _m.Called(email)

        var r0 *admin.Admin
        if rf, ok := ret.Get(0).(func(string) *admin.Admin); ok </span><span class="cov0" title="0">{
                r0 = rf(email)
        }</span> else<span class="cov0" title="0"> {
                if ret.Get(0) != nil </span><span class="cov0" title="0">{
                        r0 = ret.Get(0).(*admin.Admin)
                }</span>
        }

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}

// FindAdminByEmailAndPassword provides a mock function with given fields: email, password
func (_m *Service) FindAdminByEmailAndPassword(email string, password string) (*admin.Admin, error) <span class="cov8" title="1">{
        ret := _m.Called(email, password)

        var r0 *admin.Admin
        if rf, ok := ret.Get(0).(func(string, string) *admin.Admin); ok </span><span class="cov0" title="0">{
                r0 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*admin.Admin)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// FindAdminByID provides a mock function with given fields: id
func (_m *Service) FindAdminByID(id string) (*admin.Admin, error) <span class="cov0" title="0">{
        ret := _m.Called(id)

        var r0 *admin.Admin
        if rf, ok := ret.Get(0).(func(string) *admin.Admin); ok </span><span class="cov0" title="0">{
                r0 = rf(id)
        }</span> else<span class="cov0" title="0"> {
                if ret.Get(0) != nil </span><span class="cov0" title="0">{
                        r0 = ret.Get(0).(*admin.Admin)
                }</span>
        }

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(id)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}

// InsertAdmin provides a mock function with given fields: insertAdminSpec
func (_m *Service) InsertAdmin(insertAdminSpec admin.InsertAdminSpec) error <span class="cov0" title="0">{
        ret := _m.Called(insertAdminSpec)

        var r0 error
        if rf, ok := ret.Get(0).(func(admin.InsertAdminSpec) error); ok </span><span class="cov0" title="0">{
                r0 = rf(insertAdminSpec)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}

// UpdateAdmin provides a mock function with given fields: id, updateAdminSpec, modifier
func (_m *Service) UpdateAdmin(id string, updateAdminSpec admin.UpdateAdminSpec, modifier string) error <span class="cov0" title="0">{
        ret := _m.Called(id, updateAdminSpec, modifier)

        var r0 error
        if rf, ok := ret.Get(0).(func(string, admin.UpdateAdminSpec, string) error); ok </span><span class="cov0" title="0">{
                r0 = rf(id, updateAdminSpec, modifier)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}

// UpdateAdminPassword provides a mock function with given fields: id, password, oldPassword, modifier
func (_m *Service) UpdateAdminPassword(id string, password string, oldPassword string, modifier string) error <span class="cov0" title="0">{
        ret := _m.Called(id, password, oldPassword, modifier)

        var r0 error
        if rf, ok := ret.Get(0).(func(string, string, string, string) error); ok </span><span class="cov0" title="0">{
                r0 = rf(id, password, oldPassword, modifier)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}
</pre>
		
		<pre class="file" id="file23" style="display: none">package admin

import (
        "AltaStore/business"
        "AltaStore/util/validator"
        "time"

        "github.com/google/uuid"
        "golang.org/x/crypto/bcrypt"
)

//InsertAdminSpec create Admin spec
type InsertAdminSpec struct {
        Email     string `validate:"required"`
        FirstName string `validate:"required"`
        LastName  string `validate:"required"`
        Password  string `validate:"required"`
}

type UpdateAdminSpec struct {
        Email     string `validate:"required"`
        FirstName string `validate:"required"`
        LastName  string `validate:"required"`
}

type UpdateAdminPasswordSpec struct {
        NewPassword string `validate:"required"`
        OldPassword string `validate:"required"`
}

//=============== The implementation of those interface put below =======================
type service struct {
        repository Repository
}

//NewService Construct Admin service object
func NewService(repository Repository) Service <span class="cov8" title="1">{
        return &amp;service{
                repository,
        }
}</span>

//InsertAdmin Create new Admin and store into database
func (s *service) InsertAdmin(insertAdminSpec InsertAdminSpec) error <span class="cov8" title="1">{
        err := validator.GetValidator().Struct(insertAdminSpec)
        if err != nil </span><span class="cov0" title="0">{
                return business.ErrInvalidSpec
        }</span>

        <span class="cov8" title="1">admin, _ := s.repository.FindAdminByEmail(insertAdminSpec.Email)
        if admin != nil </span><span class="cov8" title="1">{
                return business.ErrDataExists
        }</span>

        <span class="cov8" title="1">hashedPassword, err := bcrypt.GenerateFromPassword([]byte(insertAdminSpec.Password), bcrypt.DefaultCost)
        if err != nil </span><span class="cov0" title="0">{
                return business.ErrInvalidSpec
        }</span>
        <span class="cov8" title="1">var newuuid = uuid.New().String()
        Admin := NewAdmin(
                newuuid,
                insertAdminSpec.Email,
                insertAdminSpec.FirstName,
                insertAdminSpec.LastName,
                string(hashedPassword),
                newuuid,
                time.Now(),
        )

        err = s.repository.InsertAdmin(Admin)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}

//FindAdminByAdminnameAndPassword If data not found will return nil
func (s *service) FindAdminByEmailAndPassword(email string, password string) (*Admin, error) <span class="cov8" title="1">{
        return s.repository.FindAdminByEmailAndPassword(email, password)
}</span>

//FindAdminByAdminnameAndPassword If data not found will return nil
func (s *service) FindAdminByEmail(email string) (*Admin, error) <span class="cov8" title="1">{
        return s.repository.FindAdminByEmail(email)
}</span>

//FindAdminByID If data not found will return nil without error
func (s *service) FindAdminByID(id string) (*Admin, error) <span class="cov8" title="1">{
        return s.repository.FindAdminByID(id)
}</span>

//UpdateAdminPaasword if data not found or old password wrong will return error
func (s *service) UpdateAdminPassword(id string, newpassword, oldPassword string, modifier string) error <span class="cov8" title="1">{

        admin, err := s.repository.FindAdminByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span> else<span class="cov8" title="1"> if admin == nil </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span> else<span class="cov8" title="1"> if admin.DeletedBy != "" </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span> else<span class="cov8" title="1"> {
                _, err := s.repository.FindAdminByEmailAndPassword(admin.Email, oldPassword)
                if err != nil </span><span class="cov8" title="1">{
                        return business.ErrPasswordMisMatch
                }</span>
        }
        <span class="cov8" title="1">hashedPassword, err := bcrypt.GenerateFromPassword([]byte(newpassword), bcrypt.DefaultCost)
        if err != nil </span><span class="cov0" title="0">{
                return business.ErrInvalidSpec
        }</span>
        <span class="cov8" title="1">modifiedAdmin := admin.ModifyAdminPassword(
                string(hashedPassword),
                modifier,
                time.Now(),
        )

        return s.repository.UpdateAdminPassword(modifiedAdmin)</span>
}

//UpdateAdmin if data not found will return error
func (s *service) UpdateAdmin(id string, updateAdminSpec UpdateAdminSpec, modifier string) error <span class="cov8" title="1">{
        admin, err := s.repository.FindAdminByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span> else<span class="cov8" title="1"> if admin == nil </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span> else<span class="cov8" title="1"> if admin.DeletedBy != "" </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span>

        <span class="cov8" title="1">modifiedAdmin := admin.ModifyAdmin(
                updateAdminSpec.FirstName,
                updateAdminSpec.LastName,
                time.Now(),
                modifier,
        )

        return s.repository.UpdateAdmin(modifiedAdmin)</span>
}

//DeleteAdmin if data not found will return error
func (s *service) DeleteAdmin(id string, modifier string) error <span class="cov8" title="1">{
        admin, err := s.repository.FindAdminByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span> else<span class="cov8" title="1"> if admin == nil </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span>

        <span class="cov8" title="1">deleteAdmin := admin.DeleteAdmin(
                time.Now(),
                modifier,
        )

        return s.repository.DeleteAdmin(deleteAdmin)</span>
}
</pre>
		
		<pre class="file" id="file24" style="display: none">// Code generated by mockery v2.9.4. DO NOT EDIT.

package mocks

import (
        admin "AltaStore/business/admin"
        adminauth "AltaStore/business/adminauth"

        mock "github.com/stretchr/testify/mock"
)

// Service is an autogenerated mock type for the Service type
type Service struct {
        mock.Mock
}

// AdminLogin provides a mock function with given fields: email, password
func (_m *Service) AdminLogin(email string, password string) (string, error) <span class="cov0" title="0">{
        ret := _m.Called(email, password)

        var r0 string
        if rf, ok := ret.Get(0).(func(string, string) string); ok </span><span class="cov0" title="0">{
                r0 = rf(email, password)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Get(0).(string)
        }</span>

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email, password)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}

// CreateToken provides a mock function with given fields: _a0
func (_m *Service) CreateToken(_a0 *admin.Admin) (*adminauth.TokenDetails, error) <span class="cov0" title="0">{
        ret := _m.Called(_a0)

        var r0 *adminauth.TokenDetails
        if rf, ok := ret.Get(0).(func(*admin.Admin) *adminauth.TokenDetails); ok </span><span class="cov0" title="0">{
                r0 = rf(_a0)
        }</span> else<span class="cov0" title="0"> {
                if ret.Get(0) != nil </span><span class="cov0" title="0">{
                        r0 = ret.Get(0).(*adminauth.TokenDetails)
                }</span>
        }

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(*admin.Admin) error); ok </span><span class="cov0" title="0">{
                r1 = rf(_a0)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}
</pre>
		
		<pre class="file" id="file25" style="display: none">package adminauth

import (
        "AltaStore/business"
        "AltaStore/business/admin"
        "AltaStore/config"
        "time"

        "github.com/golang-jwt/jwt"
        uuid "github.com/google/uuid"
)

//=============== The implementation of those interface put below =======================
type service struct {
        adminService admin.Service
        //authService Repository
}

// //NewService Construct admin service object
// func NewService(adminService admin.Service, authService Repository) Service {
//         return &amp;service{
//                 adminService, authService,
//         }
// }

//NewService Construct admin service object
func NewService(adminService admin.Service) Service <span class="cov8" title="1">{
        return &amp;service{
                adminService,
        }
}</span>

//Login by given admin Email and Password, return error if not exist
func (s *service) AdminLogin(adminname string, password string) (string, error) <span class="cov8" title="1">{
        admin, err := s.adminService.FindAdminByEmailAndPassword(adminname, password)
        if err != nil </span><span class="cov8" title="1">{
                return "", business.ErrUnAuthorized
        }</span>
        <span class="cov8" title="1">td, err := s.CreateToken(admin)
        if err != nil </span><span class="cov0" title="0">{
                return "", business.ErrUnAuthorized
        }</span>
        // err = s.authService.InsertToken(admin, td)
        // if err != nil {
        //         return "", business.ErrNotFound
        // }
        <span class="cov8" title="1">return td.AccessToken, nil</span>
}

func (s *service) CreateToken(admin *admin.Admin) (*TokenDetails, error) <span class="cov8" title="1">{
        td := &amp;TokenDetails{}
        td.AtExpires = time.Now().Add(time.Hour * 24).Unix()
        td.AccessUuid = uuid.New().String()

        var err error
        //Creating Access Token
        atClaims := jwt.MapClaims{}
        atClaims["authorized"] = true
        atClaims["access_uuid"] = td.AccessUuid
        atClaims["userId"] = admin.ID
        atClaims["isAdmin"] = true
        atClaims["exp"] = td.AtExpires
        at := jwt.NewWithClaims(jwt.SigningMethodHS256, atClaims)
        td.AccessToken, err = at.SignedString([]byte(config.GetConfig().JwtSecretKey))
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return td, nil</span>
}
</pre>
		
		<pre class="file" id="file26" style="display: none">package logger

import "encoding/json"

type service struct {
        repository Repository
}

func NewService(repository Repository) Service <span class="cov0" title="0">{
        return &amp;service{repository}
}</span>

func (s *service) Write(p []byte) (n int, err error) <span class="cov0" title="0">{
        var data LoggerData

        json.Unmarshal(p, &amp;data)

        return len(p), s.repository.AddLoggerActivity(&amp;data)
}</span>
</pre>
		
		<pre class="file" id="file27" style="display: none">// Code generated by mockery v2.9.4. DO NOT EDIT.

package mocks

import (
        user "AltaStore/business/user"

        mock "github.com/stretchr/testify/mock"
)

// Repository is an autogenerated mock type for the Repository type
type Repository struct {
        mock.Mock
}

// DeleteUser provides a mock function with given fields: _a0
func (_m *Repository) DeleteUser(_a0 user.User) error <span class="cov8" title="1">{
        ret := _m.Called(_a0)

        var r0 error
        if rf, ok := ret.Get(0).(func(user.User) error); ok </span><span class="cov0" title="0">{
                r0 = rf(_a0)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}

// FindUserByEmail provides a mock function with given fields: email
func (_m *Repository) FindUserByEmail(email string) (*user.User, error) <span class="cov8" title="1">{
        ret := _m.Called(email)

        var r0 *user.User
        if rf, ok := ret.Get(0).(func(string) *user.User); ok </span><span class="cov0" title="0">{
                r0 = rf(email)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*user.User)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// FindUserByEmailAndPassword provides a mock function with given fields: email, password
func (_m *Repository) FindUserByEmailAndPassword(email string, password string) (*user.User, error) <span class="cov8" title="1">{
        ret := _m.Called(email, password)

        var r0 *user.User
        if rf, ok := ret.Get(0).(func(string, string) *user.User); ok </span><span class="cov0" title="0">{
                r0 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*user.User)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// FindUserByID provides a mock function with given fields: id
func (_m *Repository) FindUserByID(id string) (*user.User, error) <span class="cov8" title="1">{
        ret := _m.Called(id)

        var r0 *user.User
        if rf, ok := ret.Get(0).(func(string) *user.User); ok </span><span class="cov0" title="0">{
                r0 = rf(id)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*user.User)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(id)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// InsertUser provides a mock function with given fields: _a0
func (_m *Repository) InsertUser(_a0 user.User) error <span class="cov8" title="1">{
        ret := _m.Called(_a0)

        var r0 error
        if rf, ok := ret.Get(0).(func(user.User) error); ok </span><span class="cov0" title="0">{
                r0 = rf(_a0)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}

// UpdateUser provides a mock function with given fields: _a0
func (_m *Repository) UpdateUser(_a0 user.User) error <span class="cov8" title="1">{
        ret := _m.Called(_a0)

        var r0 error
        if rf, ok := ret.Get(0).(func(user.User) error); ok </span><span class="cov0" title="0">{
                r0 = rf(_a0)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}

// UpdateUserPassword provides a mock function with given fields: _a0
func (_m *Repository) UpdateUserPassword(_a0 user.User) error <span class="cov8" title="1">{
        ret := _m.Called(_a0)

        var r0 error
        if rf, ok := ret.Get(0).(func(user.User) error); ok </span><span class="cov0" title="0">{
                r0 = rf(_a0)
        }</span> else<span class="cov8" title="1"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov8" title="1">return r0</span>
}
</pre>
		
		<pre class="file" id="file28" style="display: none">// Code generated by mockery v2.9.4. DO NOT EDIT.

package mocks

import (
        user "AltaStore/business/user"

        mock "github.com/stretchr/testify/mock"
)

// Service is an autogenerated mock type for the Service type
type Service struct {
        mock.Mock
}

// DeleteUser provides a mock function with given fields: id, deleter
func (_m *Service) DeleteUser(id string, deleter string) error <span class="cov0" title="0">{
        ret := _m.Called(id, deleter)

        var r0 error
        if rf, ok := ret.Get(0).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r0 = rf(id, deleter)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}

// FindUserByEmail provides a mock function with given fields: email
func (_m *Service) FindUserByEmail(email string) (*user.User, error) <span class="cov0" title="0">{
        ret := _m.Called(email)

        var r0 *user.User
        if rf, ok := ret.Get(0).(func(string) *user.User); ok </span><span class="cov0" title="0">{
                r0 = rf(email)
        }</span> else<span class="cov0" title="0"> {
                if ret.Get(0) != nil </span><span class="cov0" title="0">{
                        r0 = ret.Get(0).(*user.User)
                }</span>
        }

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}

// FindUserByEmailAndPassword provides a mock function with given fields: email, password
func (_m *Service) FindUserByEmailAndPassword(email string, password string) (*user.User, error) <span class="cov8" title="1">{
        ret := _m.Called(email, password)

        var r0 *user.User
        if rf, ok := ret.Get(0).(func(string, string) *user.User); ok </span><span class="cov0" title="0">{
                r0 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                if ret.Get(0) != nil </span><span class="cov8" title="1">{
                        r0 = ret.Get(0).(*user.User)
                }</span>
        }

        <span class="cov8" title="1">var r1 error
        if rf, ok := ret.Get(1).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email, password)
        }</span> else<span class="cov8" title="1"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov8" title="1">return r0, r1</span>
}

// FindUserByID provides a mock function with given fields: id
func (_m *Service) FindUserByID(id string) (*user.User, error) <span class="cov0" title="0">{
        ret := _m.Called(id)

        var r0 *user.User
        if rf, ok := ret.Get(0).(func(string) *user.User); ok </span><span class="cov0" title="0">{
                r0 = rf(id)
        }</span> else<span class="cov0" title="0"> {
                if ret.Get(0) != nil </span><span class="cov0" title="0">{
                        r0 = ret.Get(0).(*user.User)
                }</span>
        }

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(id)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}

// InsertUser provides a mock function with given fields: insertUserSpec
func (_m *Service) InsertUser(insertUserSpec user.InsertUserSpec) error <span class="cov0" title="0">{
        ret := _m.Called(insertUserSpec)

        var r0 error
        if rf, ok := ret.Get(0).(func(user.InsertUserSpec) error); ok </span><span class="cov0" title="0">{
                r0 = rf(insertUserSpec)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}

// UpdateUser provides a mock function with given fields: id, updateUserSpec, modifier
func (_m *Service) UpdateUser(id string, updateUserSpec user.UpdateUserSpec, modifier string) error <span class="cov0" title="0">{
        ret := _m.Called(id, updateUserSpec, modifier)

        var r0 error
        if rf, ok := ret.Get(0).(func(string, user.UpdateUserSpec, string) error); ok </span><span class="cov0" title="0">{
                r0 = rf(id, updateUserSpec, modifier)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}

// UpdateUserPassword provides a mock function with given fields: id, password, oldPassword, modifier
func (_m *Service) UpdateUserPassword(id string, password string, oldPassword string, modifier string) error <span class="cov0" title="0">{
        ret := _m.Called(id, password, oldPassword, modifier)

        var r0 error
        if rf, ok := ret.Get(0).(func(string, string, string, string) error); ok </span><span class="cov0" title="0">{
                r0 = rf(id, password, oldPassword, modifier)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Error(0)
        }</span>

        <span class="cov0" title="0">return r0</span>
}
</pre>
		
		<pre class="file" id="file29" style="display: none">package user

import (
        "AltaStore/business"
        "AltaStore/util/validator"
        "time"

        "github.com/google/uuid"
        "golang.org/x/crypto/bcrypt"
)

//InsertUserSpec create user spec
type InsertUserSpec struct {
        Email     string `validate:"required"`
        FirstName string `validate:"required"`
        LastName  string `validate:"required"`
        Password  string `validate:"required"`
}

type UpdateUserSpec struct {
        Email     string `validate:"required"`
        FirstName string `validate:"required"`
        LastName  string `validate:"required"`
        HandPhone string
        Address   string
}

type UpdateUserPasswordSpec struct {
        NewPassword string `validate:"required"`
        OldPassword string `validate:"required"`
}

//=============== The implementation of those interface put below =======================
type service struct {
        repository Repository
}

//NewService Construct user service object
func NewService(repository Repository) Service <span class="cov8" title="1">{
        return &amp;service{
                repository,
        }
}</span>

//InsertUser Create new user and store into database
func (s *service) InsertUser(insertUserSpec InsertUserSpec) error <span class="cov8" title="1">{
        err := validator.GetValidator().Struct(insertUserSpec)
        if err != nil </span><span class="cov0" title="0">{
                return business.ErrInvalidSpec
        }</span>

        <span class="cov8" title="1">userdata, _ := s.repository.FindUserByEmail(insertUserSpec.Email)
        if userdata != nil </span><span class="cov8" title="1">{
                return business.ErrDataExists
        }</span>

        <span class="cov8" title="1">hashedPassword, err := bcrypt.GenerateFromPassword([]byte(insertUserSpec.Password), bcrypt.DefaultCost)
        if err != nil </span><span class="cov0" title="0">{
                return business.ErrInvalidSpec
        }</span>
        <span class="cov8" title="1">var newuuid = uuid.New().String()
        user := NewUser(
                newuuid,
                insertUserSpec.Email,
                insertUserSpec.FirstName,
                insertUserSpec.LastName,
                string(hashedPassword),
                newuuid,
                time.Now(),
        )

        err = s.repository.InsertUser(user)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}

//FindUserByUsernameAndPassword If data not found will return nil
func (s *service) FindUserByEmailAndPassword(email string, password string) (*User, error) <span class="cov8" title="1">{
        return s.repository.FindUserByEmailAndPassword(email, password)
}</span>

//FindUserByUsername If data not found will return nil
func (s *service) FindUserByEmail(email string) (*User, error) <span class="cov8" title="1">{
        return s.repository.FindUserByEmail(email)
}</span>

//FindUserByID If data not found will return nil without error
func (s *service) FindUserByID(id string) (*User, error) <span class="cov8" title="1">{
        return s.repository.FindUserByID(id)
}</span>

//UpdateUserPaasword if data not found or old password wrong will return error
func (s *service) UpdateUserPassword(id string, newpassword, oldPassword string, modifier string) error <span class="cov8" title="1">{

        user, err := s.repository.FindUserByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span> else<span class="cov8" title="1"> if user == nil </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span> else<span class="cov8" title="1"> if user.DeletedBy != "" </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span> else<span class="cov8" title="1"> {
                _, err := s.repository.FindUserByEmailAndPassword(user.Email, oldPassword)
                if err != nil </span><span class="cov8" title="1">{
                        return business.ErrPasswordMisMatch
                }</span>
        }
        <span class="cov8" title="1">hashedPassword, err := bcrypt.GenerateFromPassword([]byte(newpassword), bcrypt.DefaultCost)
        if err != nil </span><span class="cov0" title="0">{
                return business.ErrInvalidSpec
        }</span>
        <span class="cov8" title="1">modifiedUser := user.ModifyUserPassword(
                string(hashedPassword),
                modifier,
                time.Now(),
        )

        return s.repository.UpdateUserPassword(modifiedUser)</span>
}

//UpdateUser if data not found will return error
func (s *service) UpdateUser(id string, updateUserSpec UpdateUserSpec, modifier string) error <span class="cov8" title="1">{
        user, err := s.repository.FindUserByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span> else<span class="cov8" title="1"> if user == nil </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span> else<span class="cov8" title="1"> if user.DeletedBy != "" </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span>

        <span class="cov8" title="1">modifiedUser := user.ModifyUser(
                updateUserSpec.FirstName,
                updateUserSpec.LastName,
                updateUserSpec.HandPhone,
                updateUserSpec.Address,
                time.Now(),
                modifier,
        )

        return s.repository.UpdateUser(modifiedUser)</span>
}

//Deleteuser if data not found will return error
func (s *service) DeleteUser(id string, modifier string) error <span class="cov8" title="1">{
        user, err := s.repository.FindUserByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span> else<span class="cov8" title="1"> if user == nil </span><span class="cov0" title="0">{
                return business.ErrNotFound
        }</span>

        <span class="cov8" title="1">deleteUser := user.DeleteUser(
                time.Now(),
                modifier,
        )

        return s.repository.DeleteUser(deleteUser)</span>
}
</pre>
		
		<pre class="file" id="file30" style="display: none">package user

import (
        "time"
)

//User
type User struct {
        ID        string
        Email     string
        FirstName string
        LastName  string
        Password  string
        HandPhone string
        Address   string
        CreatedAt time.Time
        CreatedBy string
        UpdatedAt time.Time
        UpdatedBy string
        DeletedAt time.Time
        DeletedBy string
}

//NewUser create new User
func NewUser(
        id string,
        email string,
        firstname string,
        lastname string,
        password string,
        creator string,
        createdAt time.Time) User <span class="cov8" title="1">{

        return User{
                ID:        id,
                Email:     email,
                FirstName: firstname,
                LastName:  lastname,
                Password:  password,
                CreatedAt: createdAt,
                CreatedBy: creator,
        }
}</span>

//ModifyUser update existing UserData
func (oldData *User) ModifyUser(
        newFirstName,
        newLastName,
        newHandPhone,
        newAddress string,
        updatedAt time.Time,
        updater string) User <span class="cov8" title="1">{

        return User{
                ID:        oldData.ID,
                Email:     oldData.Email,
                FirstName: newFirstName,
                LastName:  newLastName,
                Password:  oldData.Password,
                HandPhone: newHandPhone,
                Address:   newAddress,
                CreatedAt: oldData.CreatedAt,
                CreatedBy: oldData.CreatedBy,
                UpdatedAt: updatedAt,
                UpdatedBy: updater,
        }
}</span>

// //ModifyUserToken update existing UserData
// func (oldData *User) ModifyUserToken(
//         newToken string,
//         updatedAt time.Time) User {

//         return User{
//                 ID:        oldData.ID,
//                 Email:     oldData.Email,
//                 FirstName: oldData.FirstName,
//                 LastName:  oldData.LastName,
//                 Password:  oldData.Password,
//                 HandPhone: oldData.HandPhone,
//                 Address:   oldData.Address,
//                 Token:     newToken,
//                 CreatedAt: oldData.CreatedAt,
//                 CreatedBy: oldData.CreatedBy,
//                 UpdatedAt: updatedAt,
//                 UpdatedBy: oldData.ID,
//         }
// }

//ModifyUserPassword update existing UserData
func (oldData *User) ModifyUserPassword(
        newPassword string,
        updater string,
        updatedAt time.Time) User <span class="cov8" title="1">{

        return User{
                ID:        oldData.ID,
                Email:     oldData.Email,
                FirstName: oldData.FirstName,
                LastName:  oldData.LastName,
                Password:  newPassword,
                HandPhone: oldData.HandPhone,
                Address:   oldData.Address,
                CreatedAt: oldData.CreatedAt,
                CreatedBy: oldData.CreatedBy,
                UpdatedAt: updatedAt,
                UpdatedBy: updater,
        }
}</span>

func (oldData *User) DeleteUser(
        deleteAt time.Time,
        deleter string) User <span class="cov8" title="1">{

        return User{
                ID:        oldData.ID,
                Email:     oldData.Email,
                FirstName: oldData.FirstName,
                LastName:  oldData.LastName,
                Password:  oldData.Password,
                HandPhone: oldData.HandPhone,
                Address:   oldData.Address,
                CreatedAt: oldData.CreatedAt,
                CreatedBy: oldData.CreatedBy,
                UpdatedAt: oldData.UpdatedAt,
                UpdatedBy: oldData.UpdatedBy,
                DeletedAt: deleteAt,
                DeletedBy: deleter,
        }
}</span>
</pre>
		
		<pre class="file" id="file31" style="display: none">// Code generated by mockery v2.9.4. DO NOT EDIT.

package mocks

import (
        user "AltaStore/business/user"

        mock "github.com/stretchr/testify/mock"

        userauth "AltaStore/business/userauth"
)

// Service is an autogenerated mock type for the Service type
type Service struct {
        mock.Mock
}

// CreateToken provides a mock function with given fields: _a0
func (_m *Service) CreateToken(_a0 *user.User) (*userauth.TokenDetails, error) <span class="cov0" title="0">{
        ret := _m.Called(_a0)

        var r0 *userauth.TokenDetails
        if rf, ok := ret.Get(0).(func(*user.User) *userauth.TokenDetails); ok </span><span class="cov0" title="0">{
                r0 = rf(_a0)
        }</span> else<span class="cov0" title="0"> {
                if ret.Get(0) != nil </span><span class="cov0" title="0">{
                        r0 = ret.Get(0).(*userauth.TokenDetails)
                }</span>
        }

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(*user.User) error); ok </span><span class="cov0" title="0">{
                r1 = rf(_a0)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}

// UserLogin provides a mock function with given fields: email, password
func (_m *Service) UserLogin(email string, password string) (string, error) <span class="cov0" title="0">{
        ret := _m.Called(email, password)

        var r0 string
        if rf, ok := ret.Get(0).(func(string, string) string); ok </span><span class="cov0" title="0">{
                r0 = rf(email, password)
        }</span> else<span class="cov0" title="0"> {
                r0 = ret.Get(0).(string)
        }</span>

        <span class="cov0" title="0">var r1 error
        if rf, ok := ret.Get(1).(func(string, string) error); ok </span><span class="cov0" title="0">{
                r1 = rf(email, password)
        }</span> else<span class="cov0" title="0"> {
                r1 = ret.Error(1)
        }</span>

        <span class="cov0" title="0">return r0, r1</span>
}
</pre>
		
		<pre class="file" id="file32" style="display: none">package userauth

import (
        "AltaStore/business"
        "AltaStore/business/user"
        "AltaStore/config"
        "time"

        "github.com/golang-jwt/jwt"
        uuid "github.com/google/uuid"
)

//=============== The implementation of those interface put below =======================
type service struct {
        userService user.Service
        //authService Repository
}

// //NewService Construct user service object
// func NewService(userService user.Service, authService Repository) Service {
//         return &amp;service{
//                 userService, authService,
//         }
// }

//NewService Construct user service object
func NewService(userService user.Service) Service <span class="cov8" title="1">{
        return &amp;service{
                userService,
        }
}</span>

//Login by given user Email and Password, return error if not exist
func (s *service) UserLogin(username string, password string) (string, error) <span class="cov8" title="1">{
        user, err := s.userService.FindUserByEmailAndPassword(username, password)
        if err != nil </span><span class="cov8" title="1">{
                return "", business.ErrUnAuthorized
        }</span>
        <span class="cov8" title="1">td, err := s.CreateToken(user)
        if err != nil </span><span class="cov0" title="0">{
                return "", business.ErrUnAuthorized
        }</span>
        // err = s.authService.InsertToken(user, td)
        // if err != nil {
        //         return "", business.ErrUnAuthorized
        // }
        <span class="cov8" title="1">return td.AccessToken, nil</span>
}

func (s *service) CreateToken(user *user.User) (*TokenDetails, error) <span class="cov8" title="1">{
        td := &amp;TokenDetails{}
        td.AtExpires = time.Now().Add(time.Hour * 24).Unix()
        td.AccessUuid = uuid.New().String()

        var err error
        //Creating Access Token
        atClaims := jwt.MapClaims{}
        atClaims["authorized"] = true
        atClaims["access_uuid"] = td.AccessUuid
        atClaims["userId"] = user.ID
        atClaims["isAdmin"] = false
        atClaims["exp"] = td.AtExpires
        at := jwt.NewWithClaims(jwt.SigningMethodHS256, atClaims)
        td.AccessToken, err = at.SignedString([]byte(config.GetConfig().JwtSecretKey))
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return td, nil</span>
}
</pre>
		
		<pre class="file" id="file33" style="display: none">package config

import (
        "github.com/labstack/gommon/log"
        "github.com/spf13/viper"
)

type ConfigApp struct {
        AppHost           string `mapstructure:"app_host"`
        AppPort           int    `mapstructure:"app_port"`
        DbDriver          string `mapstructure:"db_driver"`
        DbHost            string `mapstructure:"db_host"`
        DbPort            int    `mapstructure:"db_port"`
        DbUsername        string `mapstructure:"db_username"`
        DbPassword        string `mapstructure:"db_password"`
        DbName            string `mapstructure:"db_name"`
        JwtSecretKey      string `mapstructure:"jwtsecretkey"`
        RedisHost         string `mapstructure:"redis_host"`
        RedisPort         int    `mapstructure:"redis_port"`
        MidTransServerKey string `mapstructure:"midtransserverkey"`
        MongoHost         string `mapstructure:"mongo_host"`
        MongoPort         int    `mapstructure:"mongo_port"`
        MongoUsername     string `mapstructure:"mongo_username"`
        MongoPassword     string `mapstructure:"mongo_password"`
        MongoDbName       string `mapstructure:"mongo_dbname"`
}

func GetConfig() *ConfigApp <span class="cov8" title="1">{
        // Set default config if error parsing file
        var defaConfig ConfigApp

        defaConfig.AppHost = "localhost"
        defaConfig.AppPort = 9000
        defaConfig.DbDriver = "pgsql"
        defaConfig.DbHost = "localhost"
        defaConfig.DbPort = 5432
        defaConfig.DbUsername = "postgres"
        defaConfig.DbPassword = "postgres"
        defaConfig.DbName = "altastoredb"
        defaConfig.JwtSecretKey = "AltaStore"
        defaConfig.RedisHost = "localhost"
        defaConfig.RedisPort = 9001
        defaConfig.MongoHost = "localhost"
        defaConfig.MongoPort = 27017
        defaConfig.MongoUsername = "mongo"
        defaConfig.MongoPassword = "mongo"
        defaConfig.MongoDbName = "altastoredb"

        var (
                err error
        )

        // Production
        // cwd, _ := os.Getwd()
        // viper.SetConfigFile(cwd + "/../config/.env")

        //Development
        viper.SetConfigFile("./.env")
        err = viper.ReadInConfig()
        if err != nil </span><span class="cov8" title="1">{
                log.Info("Failed read config, config set to default2.")
                return &amp;defaConfig
        }</span>

        <span class="cov0" title="0">var finalConfig ConfigApp
        err = viper.Unmarshal(&amp;finalConfig)
        if err != nil </span><span class="cov0" title="0">{
                log.Info("Failed bind config, config set to default3.")
                return &amp;defaConfig
        }</span>

        <span class="cov0" title="0">return &amp;finalConfig</span>
}
</pre>
		
		<pre class="file" id="file34" style="display: none">package main

import (
        "AltaStore/api"
        "AltaStore/api/middleware"

        // Controller
        adminController "AltaStore/api/v1/admin"
        adminAuthController "AltaStore/api/v1/adminauth"
        userController "AltaStore/api/v1/user"
        userAuthController "AltaStore/api/v1/userauth"

        // Service
        adminService "AltaStore/business/admin"
        adminAuthService "AltaStore/business/adminauth"
        loggerService "AltaStore/business/logger"
        userService "AltaStore/business/user"
        userAuthService "AltaStore/business/userauth"

        "AltaStore/config"

        // Repository
        adminRepository "AltaStore/modules/admin"
        loggerRepo "AltaStore/modules/logger"
        "AltaStore/modules/migration"
        userRepository "AltaStore/modules/user"

        "context"
        "time"

        "fmt"

        log "github.com/sirupsen/logrus"

        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"

        "github.com/go-redis/redis/v7"
        "github.com/labstack/echo/v4"
        "gorm.io/driver/postgres"
        "gorm.io/gorm"
)

func newDatabaseConnection(cfg *config.ConfigApp) *gorm.DB <span class="cov0" title="0">{
        stringConnection := fmt.Sprintf(
                "host=%s port=%d user=%s password=%s dbname=%s",
                cfg.DbHost, cfg.DbPort, cfg.DbUsername, cfg.DbPassword, cfg.DbName,
        )
        db, err := gorm.Open(postgres.Open(stringConnection), &amp;gorm.Config{})

        if err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }

        <span class="cov0" title="0">migration.TableMigration(db)

        return db</span>
}

func newMongoDBConnection(cfg *config.ConfigApp) *mongo.Database <span class="cov0" title="0">{
        clientOptions := options.Client().ApplyURI(
                fmt.Sprintf("mongodb://%s:%s@%s:%d", cfg.MongoUsername, cfg.MongoPassword, cfg.MongoHost, cfg.MongoPort),
        )

        client, err := mongo.NewClient(clientOptions)
        if err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }

        <span class="cov0" title="0">err = client.Connect(context.Background())
        if err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }

        <span class="cov0" title="0">return client.Database(cfg.MongoDbName)</span>
}

func newRedisConnection(cfg *config.ConfigApp) *redis.Client <span class="cov0" title="0">{
        // stringConnection := fmt.Sprintf(
        //         "%s:%d",
        //         cfg.RedisHost, cfg.RedisPort,
        // )
        // client := redis.NewClient(&amp;redis.Options{
        //         Addr:     stringConnection, // redis port
        //         Password: "",               // no password set
        //         DB:       0,                // use default DB
        // })
        // _, err := client.Ping().Result()
        // if err != nil {
        //         panic(err)
        // }
        // return client
        return nil
}</span>

func main() <span class="cov0" title="0">{
        // retrieves application configuration and returns common values when there is a problem
        config := config.GetConfig()

        // Open mongodb logger
        mongoConnection := newMongoDBConnection(config)

        // Register repository
        logrRepo := loggerRepo.NewRepository(mongoConnection)

        // Register service
        logeService := loggerService.NewService(logrRepo)

        // Register logs
        log.SetFormatter(&amp;log.JSONFormatter{})
        log.SetOutput(logeService)

        // open database server base session
        dbConnection := newDatabaseConnection(config)

        // open redis connection
        //redisConnection := newRedisConnection(config)
        _ = newRedisConnection(config)

        //initiate user repository
        user := userRepository.NewDBRepository(dbConnection)

        //initiate user service
        userService := userService.NewService(user)

        //initiate user controller
        userController := userController.NewController(userService)

        // Initiate Respository Category
        //_ = authRepository.NewRepository(redisConnection)

        //initiate admin repository
        admin := adminRepository.NewDBRepository(dbConnection)

        //initiate admin service
        adminService := adminService.NewService(admin)

        //initiate admin controller
        adminController := adminController.NewController(adminService)

        //initiate auth service
        userAuthService := userAuthService.NewService(userService)

        //initiate auth controller
        userAuthController := userAuthController.NewController(userAuthService)

        //initiate auth service
        adminAuthService := adminAuthService.NewService(adminService)

        //initiate auth controller
        adminAuthController := adminAuthController.NewController(adminAuthService)

        // create echo http
        e := echo.New()

        // Register API Path and Controller
        api.RegisterPath(e,
                userController,
                adminController,
                userAuthController,
                adminAuthController,
        )

        lock := make(chan error)

        go func(lock chan error) </span><span class="cov0" title="0">{
                address := fmt.Sprintf(":%d", config.AppPort)
                lock &lt;- e.Start(address)
        }</span>(lock)

        <span class="cov0" title="0">time.Sleep(1 * time.Millisecond)
        middleware.MakeLogEntry(nil).Info(fmt.Sprintf("Application Start In Port =&gt; ::%d", config.AppPort))

        err := &lt;-lock
        if err != nil </span><span class="cov0" title="0">{
                middleware.MakeLogEntry(nil).Panic("Shutdown Echo Service")
        }</span>
}
</pre>
		
		<pre class="file" id="file35" style="display: none">package admin

import (
        "AltaStore/business/admin"

        "time"

        "golang.org/x/crypto/bcrypt"
        "gorm.io/gorm"
)

// Implementasi repositori admin
type Repository struct {
        DB *gorm.DB
}

type Admin struct {
        ID        string    `gorm:"type:uuid;primary_key"`
        Email     string    `gorm:"email;index:idx_admin_email,unique;type:varchar(50)"`
        FirstName string    `gorm:"firstname;type:varchar(50)"`
        LastName  string    `gorm:"lastname;type:varchar(50)"`
        Password  string    `gorm:"password;type:varchar(100)"`
        CreatedAt time.Time `gorm:"created_at"`
        CreatedBy string    `gorm:"created_by;type:varchar(50)"`
        UpdatedAt time.Time `gorm:"updated_at"`
        UpdatedBy string    `gorm:"updated_by;type:varchar(50)"`
        DeletedAt time.Time `gorm:"deleted_at"`
        DeletedBy string    `gorm:"deleted_by;type:varchar(50)"`
}

func newAdminTable(admin admin.Admin) *Admin <span class="cov0" title="0">{

        return &amp;Admin{
                admin.ID,
                admin.Email,
                admin.FirstName,
                admin.LastName,
                admin.Password,
                admin.CreatedAt,
                admin.CreatedBy,
                admin.UpdatedAt,
                admin.UpdatedBy,
                admin.DeletedAt,
                admin.DeletedBy,
        }
}</span>

func (col *Admin) Toadmin() admin.Admin <span class="cov0" title="0">{
        var admin admin.Admin

        admin.ID = col.ID
        admin.Email = col.Email
        admin.FirstName = col.FirstName
        admin.LastName = col.LastName
        admin.CreatedAt = col.CreatedAt
        admin.CreatedBy = col.CreatedBy
        admin.UpdatedAt = col.UpdatedAt
        admin.UpdatedBy = col.UpdatedBy
        admin.DeletedAt = col.DeletedAt
        admin.DeletedBy = col.DeletedBy

        return admin
}</span>

// Menghasilkan ORM DB untuk admin repository
func NewDBRepository(db *gorm.DB) *Repository <span class="cov0" title="0">{
        return &amp;Repository{db}
}</span>

//InsertAdmin Insert new Admin into storage
func (repo *Repository) InsertAdmin(admin admin.Admin) error <span class="cov0" title="0">{

        adminData := newAdminTable(admin)

        err := repo.DB.Create(adminData).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

//FindAdminByEmailAndPassword If data not found will return nil
func (repo *Repository) FindAdminByEmailAndPassword(email string, password string) (*admin.Admin, error) <span class="cov0" title="0">{

        var adminData Admin

        err := repo.DB.Where("email = ?", email).Where("deleted_by = ''").First(&amp;adminData).Error
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        // Comparing the password with the hash
        <span class="cov0" title="0">err = bcrypt.CompareHashAndPassword([]byte(adminData.Password), []byte(password))
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">Admin := adminData.Toadmin()

        return &amp;Admin, nil</span>
}

func (repo *Repository) FindAdminByEmail(email string) (*admin.Admin, error) <span class="cov0" title="0">{

        var adminData Admin

        err := repo.DB.Where("email = ?", email).Where("deleted_by = ''").First(&amp;adminData).Error
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">Admin := adminData.Toadmin()

        return &amp;Admin, nil</span>
}

//FindAdminByID If data not found will return nil without error
func (repo *Repository) FindAdminByID(id string) (*admin.Admin, error) <span class="cov0" title="0">{

        var adminData Admin

        err := repo.DB.Where("id = ?", id).Where("deleted_by = ''").First(&amp;adminData).Error
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">Admin := adminData.Toadmin()

        return &amp;Admin, nil</span>
}

//UpdateAdminPassword if data not found or old password wrong will return error
func (repo *Repository) UpdateAdminPassword(admin admin.Admin) error <span class="cov0" title="0">{
        adminData := newAdminTable(admin)

        err := repo.DB.Model(&amp;adminData).Updates(Admin{
                Password: adminData.Password,
        }).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

//UpdateAdmin Update existing Admin in database
func (repo *Repository) UpdateAdmin(admin admin.Admin) error <span class="cov0" title="0">{
        AdminData := newAdminTable(admin)

        err := repo.DB.Model(&amp;AdminData).Updates(Admin{
                FirstName: AdminData.FirstName,
                LastName:  AdminData.LastName,
                Password:  AdminData.Password,
                UpdatedAt: AdminData.UpdatedAt,
                UpdatedBy: AdminData.UpdatedBy,
        }).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

//DeleteAdmin Set IsDelete true in database
func (repo *Repository) DeleteAdmin(admin admin.Admin) error <span class="cov0" title="0">{
        adminData := newAdminTable(admin)

        err := repo.DB.Model(&amp;adminData).Updates(Admin{
                DeletedBy: adminData.DeletedBy,
                DeletedAt: adminData.DeletedAt,
        }).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file36" style="display: none">package logger

import (
        "context"

        "AltaStore/business/logger"

        "go.mongodb.org/mongo-driver/mongo"
)

type Repository struct {
        DB *mongo.Database
}

func NewRepository(db *mongo.Database) *Repository <span class="cov0" title="0">{
        return &amp;Repository{db}
}</span>

func (r *Repository) AddLoggerActivity(data *logger.LoggerData) error <span class="cov0" title="0">{

        _, err := r.DB.Collection("logs").InsertOne(context.Background(), data)

        return err
}</span>
</pre>
		
		<pre class="file" id="file37" style="display: none">package migration

import (
        "AltaStore/modules/admin"
        "AltaStore/modules/user"

        "gorm.io/gorm"
)

func TableMigration(db *gorm.DB) <span class="cov0" title="0">{
        db.AutoMigrate(
                &amp;user.User{},
                &amp;admin.Admin{},
        )
}</span>
</pre>
		
		<pre class="file" id="file38" style="display: none">package user

import (
        "AltaStore/business/user"

        "time"

        "golang.org/x/crypto/bcrypt"
        "gorm.io/gorm"
)

// Implementasi repositori user
type Repository struct {
        DB *gorm.DB
}

type User struct {
        ID        string    `gorm:"type:uuid;primary_key"`
        Email     string    `gorm:"email;index:idx_email,unique;type:varchar(50)"`
        FirstName string    `gorm:"firstname;type:varchar(50)"`
        LastName  string    `gorm:"lastname;type:varchar(50)"`
        Password  string    `gorm:"password;type:varchar(100)"`
        HandPhone string    `gorm:"handphone;type:varchar(50)"`
        Address   string    `gorm:"address;type:varchar(100)"`
        CreatedAt time.Time `gorm:"created_at"`
        CreatedBy string    `gorm:"created_by;type:varchar(50)"`
        UpdatedAt time.Time `gorm:"updated_at"`
        UpdatedBy string    `gorm:"updated_by;type:varchar(50)"`
        DeletedAt time.Time `gorm:"deleted_at"`
        DeletedBy string    `gorm:"deleted_by;type:varchar(50)"`
}

func newUserTable(user user.User) *User <span class="cov0" title="0">{

        return &amp;User{
                user.ID,
                user.Email,
                user.FirstName,
                user.LastName,
                user.Password,
                user.HandPhone,
                user.Address,
                user.CreatedAt,
                user.CreatedBy,
                user.UpdatedAt,
                user.UpdatedBy,
                user.DeletedAt,
                user.DeletedBy,
        }
}</span>

func (col *User) ToUser() user.User <span class="cov0" title="0">{
        var user user.User

        user.ID = col.ID
        user.Email = col.Email
        user.FirstName = col.FirstName
        user.LastName = col.LastName
        user.HandPhone = col.HandPhone
        user.Address = col.Address
        user.CreatedAt = col.CreatedAt
        user.CreatedBy = col.CreatedBy
        user.UpdatedAt = col.UpdatedAt
        user.UpdatedBy = col.UpdatedBy
        user.DeletedAt = col.DeletedAt
        user.DeletedBy = col.DeletedBy

        return user
}</span>

// Menghasilkan ORM DB untuk user repository
func NewDBRepository(db *gorm.DB) *Repository <span class="cov0" title="0">{
        return &amp;Repository{db}
}</span>

//InsertUser Insert new User into storage
func (repo *Repository) InsertUser(user user.User) error <span class="cov0" title="0">{

        userData := newUserTable(user)

        err := repo.DB.Create(userData).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

//FindUserByEmailAndPassword If data not found will return nil
func (repo *Repository) FindUserByEmailAndPassword(email string, password string) (*user.User, error) <span class="cov0" title="0">{

        var userData User

        err := repo.DB.Where("email = ?", email).Where("deleted_by = ''").First(&amp;userData).Error
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        // Comparing the password with the hash
        <span class="cov0" title="0">err = bcrypt.CompareHashAndPassword([]byte(userData.Password), []byte(password))
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">user := userData.ToUser()

        return &amp;user, nil</span>
}

func (repo *Repository) FindUserByEmail(email string) (*user.User, error) <span class="cov0" title="0">{

        var userData User

        err := repo.DB.Where("email = ?", email).Where("deleted_by = ''").First(&amp;userData).Error
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">user := userData.ToUser()

        return &amp;user, nil</span>
}

//FindUserByID If data not found will return nil without error
func (repo *Repository) FindUserByID(id string) (*user.User, error) <span class="cov0" title="0">{

        var userData User

        err := repo.DB.Where("id = ?", id).Where("deleted_by = ''").First(&amp;userData).Error
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">user := userData.ToUser()

        return &amp;user, nil</span>
}

//UpdateUserPassword if data not found or old password wrong will return error
func (repo *Repository) UpdateUserPassword(user user.User) error <span class="cov0" title="0">{
        userData := newUserTable(user)

        err := repo.DB.Model(&amp;userData).Updates(User{
                Password: userData.Password,
        }).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

//UpdateUser Update existing user in database
func (repo *Repository) UpdateUser(user user.User) error <span class="cov0" title="0">{
        userData := newUserTable(user)

        err := repo.DB.Model(&amp;userData).Updates(User{
                FirstName: userData.FirstName,
                LastName:  userData.LastName,
                Address:   userData.Address,
                Password:  userData.Password,
                HandPhone: userData.HandPhone,
                UpdatedAt: userData.UpdatedAt,
                UpdatedBy: userData.UpdatedBy,
        }).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

//DeleteUser Set IsDelete true in database
func (repo *Repository) DeleteUser(user user.User) error <span class="cov0" title="0">{
        userData := newUserTable(user)

        err := repo.DB.Model(&amp;userData).Updates(User{
                DeletedBy: userData.DeletedBy,
                DeletedAt: userData.DeletedAt,
        }).Error
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file39" style="display: none">package validator

import (
        "sync"

        "github.com/go-playground/validator/v10"
)

var lock = &amp;sync.Mutex{}
var validate *validator.Validate

//GetValidator Initiatilize validator in singleton way
func GetValidator() *validator.Validate <span class="cov8" title="1">{
        lock.Lock()
        defer lock.Unlock()

        if validate == nil </span><span class="cov8" title="1">{
                validate = validator.New()
        }</span>

        <span class="cov8" title="1">return validate</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
